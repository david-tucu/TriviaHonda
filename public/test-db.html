<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas de consultas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        /* Eliminamos el CSS custom anterior ya que Bootstrap lo maneja */
        /* Podemos mantener un poco de padding en el cuerpo si es necesario */
        body {
            padding-top: 20px;
        }

        /* Ajuste menor para separar el mensaje del resultado */
        #resultado {
            margin-top: 20px;
        }
        /* todas las celdas centradas */
        td, th {
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container-fluid">

        <h1 class="mb-4">Pruebas de conexiÃ³n</h1>

        <div class="d-grid gap-2 d-sm-flex justify-content-sm-start mb-4">
            <button id="btn" class="btn btn-primary">Usuarios</button>
            <button id="verRank" class="btn btn-primary">Ver Ranking</button>
            <button id="btn500" class="btn btn-primary">Ãšltimas 500 Acciones</button>
        </div>

        <div id="resultado" class="alert alert-info" role="alert">Ejecutar una acciÃ³n</div>

        <div id="table-container"></div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7tH6S8tLSA"
        crossorigin="anonymous"></script>

    <script>
        function renderTable(data) {
            if (data.length === 0) {
                document.getElementById("resultado").className = "alert alert-warning";
                document.getElementById("resultado").innerHTML = "No hay registros.";
                document.getElementById("table-container").innerHTML = "";
                return;
            }

            // Cambiamos el mensaje de resultado a Ã©xito o informaciÃ³n
            document.getElementById("resultado").className = "alert alert-success";
            document.getElementById("resultado").innerHTML = `Mostrando ${data.length} registros.`;
            
            // ðŸ”‘ 4. Usamos un div responsive para la tabla
            let html = '<div class="table-responsive">';
            
            // ðŸ”‘ 5. Clases de tabla Bootstrap: table (base), table-striped (cebra), table-hover
            html += '<table class="table table-striped table-hover table-sm">'; 
            html += "<thead><tr>";

            const cols = Object.keys(data[0]);
            cols.forEach(c => html += `<th scope="col">${c}</th>`);
            html += "</tr></thead><tbody>"; // Usar thead y tbody es buena prÃ¡ctica

            data.forEach(row => {
                //si el dato es true/false muestra "âˆš" o "Â·"
                Object.keys(row).forEach(key => {
                    if (row[key] === true || row[key] === false) {
                        row[key] = row[key] ? "âˆš" : "Â·";
                    }
                });


                html += "<tr>";
                cols.forEach(c => html += `<td>${row[c]}</td>`);
                html += "</tr>";
            });

            html += "</tbody></table></div>"; // Cerrar tbody, table, y el div responsive
            document.getElementById("table-container").innerHTML = html;
        }
        
        // --- HANDLERS FETCH ---

        // FunciÃ³n reutilizable para manejar la lÃ³gica de fetch
        function fetchData(endpoint, message) {
            document.getElementById("resultado").className = "alert alert-info";
            document.getElementById("resultado").innerHTML = message;

            fetch(endpoint)
                .then(r => r.json())
                .then(result => {
                    if (!result.ok) {
                        document.getElementById("resultado").className = "alert alert-danger";
                        document.getElementById("resultado").innerHTML = "Error: " + result.error;
                        document.getElementById("table-container").innerHTML = "";
                        return;
                    }
                    renderTable(result.data);
                })
                .catch(err => {
                    document.getElementById("resultado").className = "alert alert-danger";
                    document.getElementById("resultado").textContent = "Error de conexiÃ³n: " + err;
                    document.getElementById("table-container").innerHTML = "";
                });
        }

        // BotÃ³n: Probar conexiÃ³n
        document.getElementById("btn").onclick = () => {
            fetchData("/test-db", "Consultando conexiÃ³nâ€¦");
        };

        // BotÃ³n: Ãšltimas 200 participaciones
        document.getElementById("btn500").onclick = () => {
            fetchData("/test-db-500", "Consultando Ãºltimas accionesâ€¦");
        };

        // Boton ver 17 ganadores:
        document.getElementById("verRank").onclick = () => {
            fetchData("/ver-rank", "Calculando ranking...");
        };
    </script>

</body>

</html>