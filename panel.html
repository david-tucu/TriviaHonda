<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin Trivia HONDA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles-admin.css">


  <style>
  </style>
</head>

<body>

  <div class="container">
    <h1 class="mb-2 text-center">PANEL TRIVIA HONDA</h1>

    <div id="status-message" class="alert alert-info d-flex align-center align-items-center" role="alert">
      <div id="spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status"></div>
      <div id="message-text">Conectando con el servidor...</div>
    </div>




    <div class="row">
      <div class="col-12 mb-2">

        <div class="row mb-1 justify-content-center">
          <div class="col col-6">
            <div id="status-info">
              <h3 class="mb-1 text-center">DISPOSITIVOS</h3>

              <p class="text-center">CONECTADOS: <span id="count-conectados"></span><br>
                RESPONDIERON: <span id="count-votos"></span></p>
            </div>
          </div>
          <div class="col col-6">
            <h3 class="mb-1 text-center">TIMER</h3>
            <div class="row mb-4 justify-content-center">
              <div class="col-md-6 col-lg-4">
                <select id="selectTiempo" class="form-select form-select-lg">
                  <option value="10000">10 segundos</option>
                  <option value="15000" selected>15 segundos</option>
                  <option value="20000">20 segundos</option>
                  <option value="25000">25 segundos</option>
                </select>
              </div>
            </div>


          </div>
        </div>


        <h3 class="mb-1 text-center">CONTROL PREGUNTAS</h3>
        <div id="question-controls">
        </div>
      </div>

      <div class="col-12 mb-2">


        <h3 class="mb-1 text-center">PANTALLA RANKING</h3>

        <div class="row">
          <div class="col-6">
            <button id="btn-ranking" onclick="pasarPantallaRanking()" class="btn btn-primary btn-action  w-100">
              PANTALLA RANKING
            </button>
          </div>
          <div class="col-6">
            <button id="btn-pantalla-ranking" onclick="mostrarRanking()" class="btn btn-info btn-action  w-100">
              MOSTRAR GANADORES
            </button>
          </div>

        </div>
        <div class="row">
          <div class="col-12">
            <button id="btn-ranking" onclick="irAInicio()" class="btn btn-primary btn-action  w-100">
              IR A INICIO
            </button>
          </div>
        </div>

      </div>
    </div>

    <h3 class="mt-2 text-center">LOGS</h3>
    <div id="log-area" class="border"></div>
  </div>

  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script>
    // Conexión a Socket.IO. Se conecta al mismo origen donde se sirve el HTML.
    const socket = io();
    const NUM_PREGUNTAS = 4; // Puedes cambiar esto

    // --- Referencias del DOM ---
    const statusDiv = document.getElementById('status-message');
    const spinner = document.getElementById('spinner');
    const messageText = document.getElementById('message-text');
    const questionControls = document.getElementById('question-controls');
    const logArea = document.getElementById('log-area');

    // --- Funciones de Utilidad ---

    /** Muestra un mensaje temporal con o sin spinner */
    function updateStatus(message, showSpinner = false, type = 'info') {
      messageText.textContent = message;
      statusDiv.className = `alert alert-${type} d-flex align-items-center`;
      if (showSpinner) {
        spinner.classList.remove('d-none');
      } else {
        spinner.classList.add('d-none');
      }
      logMessage(`STATUS: ${message}`);
    }

    /** Muestra un mensaje en el área de logs */
    function logMessage(message) {
      const time = new Date().toLocaleTimeString();
      logArea.innerHTML += `<div>[${time}] ${message}</div>`;
      logArea.scrollTop = logArea.scrollHeight; // Auto-scroll
    }

    // --- Generación de Botonera (Punto Solicitado) ---

    function createQuestionButtons() {
      // Obtenemos el contenedor donde se añadirán las filas de botones
      const questionControls = document.getElementById('question-controls');

      const selectTiempo = document.getElementById('selectTiempo');


      for (let i = 1; i <= NUM_PREGUNTAS; i++) {
        // 1. Crear la fila (div.row) para contener ambos botones
        const row = document.createElement('div');
        row.className = 'row mb-1';

        // --- COLUMNA 1: Botón Mostrar Pregunta ---
        const colQ = document.createElement('div');
        colQ.className = 'col-6'; // Ocupa la mitad del ancho de la fila

        const btnQ = document.createElement('button');
        btnQ.textContent = `PREGUNTA ${i}`;
        // d-grid hace que el botón ocupe todo el ancho de la columna
        btnQ.className = 'btn btn-primary d-grid btn-action w-100';

        btnQ.onclick = () => {
          //  CAMBIO CLAVE: Capturar el valor del select ANTES de enviar
          const tiempoSeleccionado = parseInt(selectTiempo.value); // Valor en MS

          const payload = {
            preguntaId: i, // ID de la pregunta
            tiempoMs: tiempoSeleccionado // Nuevo valor de tiempo
          };

          enviarAccion('mostrarPregunta', payload, `Pregunta ${i} enviada con ${tiempoSeleccionado / 1000}s.`);
        };

        colQ.appendChild(btnQ);
        row.appendChild(colQ);

        // --- COLUMNA 2: Botón Destacar Respuesta ---
        const colR = document.createElement('div');
        colR.className = 'col-3'; // Ocupa la otra mitad del ancho de la fila

        const btnR = document.createElement('button');
        btnR.textContent = `RESP`;
        // d-grid hace que el botón ocupe todo el ancho de la columna
        btnR.className = 'btn btn-success d-grid btn-action w-100';
        btnR.onclick = () => enviarAccion('destacarRespuesta', i, `Respuesta ${i} destacada.`);

        colR.appendChild(btnR);
        row.appendChild(colR);


        // --- COLUMNA 3: Botón QUITAR Pregunta ---
        const colQuitar = document.createElement('div');
        colQuitar.className = 'col-3'; // Ocupa la otra mitad del ancho de la fila

        const btnQuitar = document.createElement('button');
        btnQuitar.textContent = `QUITAR`;
        // d-grid hace que el botón ocupe todo el ancho de la columna
        btnQuitar.className = 'btn btn-danger d-grid btn-action w-100';
        btnQuitar.onclick = () => irAInicio();

        colQuitar.appendChild(btnQuitar);
        row.appendChild(colQuitar);





        // Añadir la fila completa al contenedor principal
        questionControls.appendChild(row);
      }
    }
    // --- Acciones de Socket.IO (Reemplazando Fetch) ---

    /** * Función genérica para enviar acciones al servidor Node.js
     * @param {string} eventName - El nombre del evento Socket.IO (ej: 'mostrarPregunta')
     * @param {number|null} data - Los datos a enviar (ej: el ID de la pregunta)
     * @param {string} successMessage - Mensaje a mostrar al enviar
     */
    function enviarAccion(eventName, data = null, successMessage = "Acción enviada...") {
      updateStatus(successMessage, true);

      console.log("enviando accion: ", eventName, data);

      const payload = {
        action: eventName,
        data: data
      };

      // Emitir el evento al servidor
      socket.emit('adminAction', payload);
    }

    // --- Botones de Control de Flujo ---

    function irAInicio() {
      enviarAccion('irAInicio', null, "Quitando pregunta. Ir a inicio. Móviles deshabilitados.");
    }

    function pasarPantallaRanking() {
      enviarAccion('pantallaRanking', null, "Cambiando a pantalla de ranking.");
    }

    function mostrarRanking() {
      enviarAccion('mostrarRanking', null, "Mostrando resultados del ranking. Móviles deshabilitados.");
    }

    // --- Handlers de Eventos de Socket.IO ---

    // El cliente se conectó exitosamente
    socket.on('connect', () => {
      updateStatus("Conectado. Panel Listo para enviar comandos.", false, 'success');
    });

    // El servidor confirma una acción enviada
    socket.on('actionConfirmed', (data) => {
      const { action, success } = data;
      if (success) {
        updateStatus(`[OK] Acción '${action}' ejecutada por el servidor.`, false, 'success');
      } else {
        updateStatus(`[ERROR] Fallo al ejecutar '${action}'.`, false, 'danger');
      }
    });

    // En panel.html:
    socket.on('statusUpdate', (status) => {
      let conectados = status.connectedClients;
      const votos = status.totalVotes;




      //limitar que noectados no sea negativo
      if (conectados > 0) {
        conectados--; //le resto 1 (por el panel)
      }
      if (conectados <= 0) {
        conectados = 0;
      }
      //limitar votos entre 0 y conectados:
      if (votos < 0) {
        votos = 0;
      }
      if (votos > conectados) {
        votos = conectados;
      }



      //console.log(`Clientes conectados: ${conectados}`);
      //console.log(`Votos recibidos para esta pregunta: ${votos}`);

      // Aquí actualiza el DOM de su panel con estos valores
      document.getElementById('count-conectados').textContent = conectados;
      document.getElementById('count-votos').textContent = votos;
    });

    // El cliente se desconectó
    socket.on('disconnect', () => {
      updateStatus("Desconectado. Intentando reconectar...", true, 'warning');
    });


    // Inicializar los botones
    createQuestionButtons();

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>